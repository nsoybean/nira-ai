// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MESSAGE TABLES - Based on Vercel AI SDK UIMessage format
// ============================================================================

model Message {
  id             String   @id // UUID from AI SDK
  conversationId String   @map("conversation_id")
  role           String   // 'user' | 'assistant' | 'system'
  parts          Json     // Array of message parts (UIMessagePart[])
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
  @@index([conversationId])
  @@index([createdAt])
}

// ============================================================================
// CUSTOM TABLES - Lume-specific business logic
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  preferences  UserPreference?
  modelUsage   ModelUsage[]
  conversations Conversation[]

  @@map("users")
}

model UserPreference {
  id           String  @id @default(uuid())
  userId       String  @unique @map("user_id")
  defaultModel String  @default("claude-3-5-sonnet-20241022") @map("default_model")
  theme        String  @default("light") // 'light' | 'dark'
  settings     Json?   // Additional user settings

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Conversation {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id") // Nullable for anonymous users
  title         String   @default("New Chat")
  modelId       String   @default("claude-3-7-sonnet-20250219") @map("model_id") // Selected AI model
  websearch     Boolean  @default(false)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  lastMessageAt DateTime @default(now()) @map("last_message_at") // Last time a message was added

  // Relations
  user       User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages   Message[]
  modelUsage ModelUsage[]

  @@map("conversations")
  @@index([userId])
  @@index([createdAt])
  @@index([lastMessageAt])
}

model ModelUsage {
  id               String   @id @default(uuid())
  conversationId   String   @map("conversation_id")
  userId           String?  @map("user_id") // Nullable for anonymous users
  modelId          String   @map("model_id") // e.g., 'claude-3-5-sonnet-20241022'
  modelProvider    String   @map("model_provider") // 'openai' | 'anthropic' | 'google'
  inputTokens      Int      @default(0) @map("input_tokens")
  outputTokens     Int      @default(0) @map("output_tokens")
  totalTokens      Int      @default(0) @map("total_tokens")
  estimatedCost    Float    @default(0) @map("estimated_cost") // In USD
  responseTimeMs   Int?     @map("response_time_ms") // Response time in milliseconds
  success          Boolean  @default(true)
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("model_usage")
  @@index([conversationId])
  @@index([userId])
  @@index([modelId])
  @@index([createdAt])
}
